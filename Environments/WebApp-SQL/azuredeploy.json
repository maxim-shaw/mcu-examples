{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "Environment Number": {
            "type": "int",
            "metadata": {
                "description": "Give the environment a number for user VMs naming. (e.g.: 1, 2, etc.)" 
            }
        },
        "Database Administrator Login": {
            "type": "string",
            "metadata": {
                "description": "Database administrator login name"
            }
        },
        "Database Administrator Login Password": {
            "type": "securestring",
            "metadata": {
                "description": "Database administrator password"
            }
        },
        "Application VM Size": {
            "type": "string",
            "defaultValue": "Standard_B2ms",
            "allowedValues": [
                "Standard_B2ms",
                "Standard_B2s",
                "Standard_B4ms"
            ],
            "metadata": {
                "description": "Size of application server VM"
            }
        },
        "Database VM Size": {
            "type": "string",
            "defaultValue": "Standard_B4ms",
            "allowedValues": [
                "Standard_B2ms",
                "Standard_B2s",
                "Standard_B4ms"
            ],
            "metadata": {
                "description": "Size of database server VM"
            }
        },
        "DTLSubnetId": {
            "type": "string",
            "defaultValue": "$(LabSubnetId)"
        }
    },
    "variables": {
        "resourceNamePrefix": "AZ1",
        "databaseVmName": "[concat(variables('resourceNamePrefix'), 'DBD', parameters('Environment Number'))]",
        "databaseName": "[concat('db-mcu-', toLower(variables('resourceNamePrefix')), '-', parameters('Environment Number'))]",
        "databaseServerName": "[concat('dbs-mcu-', toLower(variables('resourceNamePrefix')), parameters('Environment Number'))]",
        "databaseDataDisk": "[concat(variables('databaseVmName'), '_OsDisk_1_', take(uniqueString(resourceGroup().id),32))]",
        //"databaseName": "[concat('db', uniqueString(resourceGroup().id, variables('siteName')))]",
        "databaseVersion": "12.0"
    },
    "resources": [
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[variables('databaseVmName')]",
            "location": "canadacentral",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/disks/', variables('databaseDataDisk'))]"
            ],
            "tags": {
                "env": "DevTestLabs",
                "ClientName": "MCU"
            },
            "properties": {
                "hardvareProfile": {
                    "vmSize": "[parameters('Database VM Size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "microsoftsqlserver",
                        "offer": "sql2019-ws2019",
                        "sku": "sqldev",
                        "version": "latest"
                    },
                    "osDisk": {
                        //"osType": "Windows",
                        //"name": "[concat(variables('databaseVmName'), '_OsDisk_1_', take(uniqueString(resourceGroup().id),32))]",
                        "createOption": "FromImage",
                        //"caching": "ReadWrite",
                        // "managedDisk": {
                        //     "storageAccountType": "StandardSSD_LRS",
                        //     "id": "[parameters('disks_AZ1ADSMCUPOC101_OsDisk_1_bf0f3232082f4093838e4882c2fbae0d_externalid')]"
                        // },
                        "diskSizeGB": 127
                    },
                    "dataDisks": [
                        {
                            "lun": 0,
                            "name": "[variables('databaseDataDisk')]",
                            "createOption": "attach",
                            "managedDisk": {
                                "id": "[resourceId('Microsoft.Compute/disks/', variables('databaseDataDisk'))]"
                            }   
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[variables('databaseVmName')]",
                    "adminUsername": "maxim",
                    "windowsConfiguration": {
                        "provisionVMAgent": true,
                        "enableAutomaticUpdates": true
                    },
                    "secrets": "[parameters('Database Administrator Login Password')]",
                    "allowExtensionOperations": true,
                    "requireGuestProvisionSignal": true
                }
            }
        }
        //  {
        //     "name": "[variables('databaseServerName')]",
        //     "type": "Microsoft.Sql/servers",
        //     "apiVersion": "2014-04-01",
        //     "location": "[resourceGroup().location]",
        //     "properties": {
        //         "administratorLogin": "[parameters('Database Administrator Login')]",
        //         "administratorLoginPassword": "[parameters('Database Administrator Login Password')]",
        //         "version": "[variables('databaseVersion')]"
        //     },
            // "resources": [
            //     {
            //         "name": "[variables('databaseName')]",
            //         "type": "databases",
            //         "apiVersion": "2015-01-01",
            //         "location": "[resourceGroup().location]",
            //         "dependsOn": [
            //             "[variables('databaseServerName')]"
            //         ],
            //         "properties": {
            //             "edition": "Basic",
            //             "collation": "SQL_Latin1_General_CP1_CI_AS",
            //             "maxSizeBytes": "1073741824",
            //             "requestedServiceObjectiveName": "Basic"
            //         }
            //     },
            //     {
            //         "type": "firewallrules",
            //         "apiVersion": "2014-04-01",
            //         "dependsOn": [
            //             "[variables('databaseServerName')]"
            //         ],
            //         "location": "[resourceGroup().location]",
            //         "name": "AllowAllWindowsAzureIps",
            //         "properties": {
            //             "endIpAddress": "0.0.0.0",
            //             "startIpAddress": "0.0.0.0"
            //         }
            //     }
            // ]
    ]
}